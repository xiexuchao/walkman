OAuth详解
================
  OAuth(开放授权)是一个开放标准， 允许用户让第三方应用访问该用户在某一网站上存储的私密资源(如照片、视频、联系人等列表)， 而无需将用户名和密码提供给第三方应用。
  
  OAuth允许用户提供一个令牌， 而不是用户名和密码来访问它们存储在特定服务提供者的数据。 每一个令牌授权一个特定的网站(例如视频编辑网站)在特定的时段内(比如在接下来的2格小时内)访问特定的资源(例如仅仅是某一相册中的视频)。 这样，OAuth让用户可以授权第三方网站访问它们存储在另外服务提供者的某些特定信息， 而非所有内容。
  
```
  +------------------+     2. 连接，请求            +----------------------+
  |                  | <--------------------------  |                      |
  |  授权方(如QQ)    |                              |       第三方应用     |
  |                  | -------------------------->  |                      |
  +------------------+     4. 获得用户信息          +----------------------+
           ^                                                 ^
           |                                                 |
           | 3. 授权访问                                     |
           |                                                 |
           |                                                 |
           |                                                 |
  +-----------------------+                                  |
  |                       |       1. 访问                    |
  |         用户          |----------------------------------+
  |                       |
  +-----------------------+
```
  上面流程中分为四个步骤， 下面是4个步骤的详解:
  1. 用户访问第三方应用， 比如: 你需要使用QQ登录的第三方网站
  2. 当你点击QQ登录的时候, 第三方网站将会连接并进行请求，比如: 点击登录后，第三方网站会跳转到QQ平台，提示你进行登录。
  3. 你要进行授权第三方网站对你对信息访问的一个权限，比如: 当你QQ登录成功后，QQ会提示你，是否授权第三方Web访问你的用户基本信息或其他的资源信息， 这时你点击授权即可。
  4. 授权后，第三方web即可访问你刚才授权的资源信息， 比如:你的QQ基本信息: 头像，昵称，性别等。

  通过这个原理流程及讲解， 基本上了解了OAuth的基本流程。
  
OAuth 1.0的认证过程
====================
  在OAuth 1.0认证中， 会用到三个重要的Url:
  1. Request Token Url: 获取未授权的Token的URL
  2. User Authorization URL: 请求用户对Token进行授权的URL
  3. Request Access Url: 使用Token获取Access Token的URL

```
      +--------------------+     Request Token URL             +--------------------------------+
  (1) | 请求临时Token      | ------------------------------->  |  生成临时Token                 |
      +--------------------+                                   +--------------------------------+
                                                                               |
                                                                               |
      +--------------------+                                                   |
      |     调整至用户     | <-------------------------------------------------+
  (2) |                    |     Request User URL              +--------------------------------+
      |      授权地址      | ------------------------------->  |                                |
      +--------------------+     (提示登录、给予授权)          |          生成Auth Token        |
                                                               |                                |
                                                               +--------------------------------+
                                                                               |
      +--------------------+                                                   |
      |                    | <-------------------------------------------------+
  (3) | 请求Access Token   |     Request Access URL            +--------------------------------+
      |                    | ------------------------------->  |  生成Access Token              |
      +--------------------+                                   +--------------------------------+
                                                                               |
                  +------------------------------------------------------------+
                  |
                  V
      +--------------------+     Request info URL              +---------------------------+
      |  请求用户资源信息  | ------------------------------->  |   返回用户信息            |
      +--------------------+                                   +---------------------------+
```
  1. 网站向认证平台平台请求一个未授权的Token, 这个Request Token URL是前面说的第一个URL
  2. 跳转至用户授权页面，提示用户进行登录，并进行授权， 返回获得已授权的Token, 用到的User Authorization URL是前面说到的第二个URL.
  3. 通过已授权的Token, 向认证平台请求Access Token(数据令牌)， 用到的Request Access URL是前面说到的第三个URL, 返回到这步，整个认证流程就结束了。
  4. 最后一步， 是通过数据令牌等参数，调用接口获取用户信息， 不完全算认证的流程。


OAuth 2.0认证流程
=================
  1. 得到授权码code
  2. 获取Access token
  3. 通过access token, 获取OpenID
  4. 通过access token及OpenID调用API, 获取用户授权信息

应用场景 Use Case
---------------------
  假设有一个"云冲印"的网站， 可以将用户存储在google上的照片，冲印出来。 用户为了使用该服务， 必须让"云冲印"读取自己存储在Google上的照片。
  
  问题是只有得到用户的授权， Google才会同意"云冲印"读取这些照片。 那么， "云冲印"怎样获得用户的授权呢?
  
  传统方法是， 用户将自己的Google账号和密码， 告诉云冲印， 后者就可以读取用户的照片了。 这样的做法有以下几个严重的缺点。
  
  1. 云冲印为了后续的服务， 会保存用户的密码， 这样很不安全。
  2. Google不得不部署密码登录， 而我们知道， 单纯的密码登录并不安全。
  3. 云冲印拥有了获取用户储存在Google所有资源的权力，用户没法限制云冲印获得授权的范围和有效期。
  4. 用户只有修改了密码， 才能收回赋予云冲印的权力。 但是这样做， 会使得其他所有获得用户授权的第三方应用程序全部实效。
  5. 只要有一个第三方应用程序被破解， 就会导致用户密码泄漏， 以及所有被密码保护的数据泄漏。
  
名词定义
-------------
  在详细介绍OAuth 2.0之前， 需要了解几个专用名词。
  1. Third-party application: 第三方应用程序， 本文中又称"客户端"(client), 即上一节例子中的云冲印。
  2. HTTP Server: HTTP服务提供商，本文中简称"服务提供商"， 即用例中的Google。
  3. Resource Owner: 资源拥有者， 本文中也称"用户"(user)。
  4. Authorization Server: 认证服务器， 即服务提供商专门用来处理认证的服务器。
  5. Resource Server: 资源服务器， 即服务提供商存放用户生成的资源的服务器。 它与认证服务器，可以是同一台机器，也可以是不同服务器。

  有了上面的术语， 就不难理解OAuth的作用就是让“客户端”安全可控地获取“用户”的授权，与“服务提供商”进行交互。

OAuth的思路
------------------
  OAuth在客户端和服务提供商之间，设置了一个授权层(authorization layer). 客户端不能直接登录服务提供商， 只能登录授权层， 以此将用户与客户端区分开来。 客户端登录授权层所用的令牌(Token), 与用户的密码不同。 用户可以在登录的时候， 指定授权层令牌的权限范围和有效期。
  
  客户端登录授权层以后， 服务器提供商根据令牌的权限范围和有效期， 向客户端开放用户存储的资料。

运行流程
------------
```
+----------+                                                           +-----------------+
|          | ---------------1. Authorization Request -------------->   |                 |
|          |                                                           | Resource Owner  |
|          | <--------------2. Authorization Grant -----------------   |                 |
|          |                                                           +-----------------+
|          |
|          |                                                           +-----------------+
| Client   | ---------------3. Authorization Grant ----------------->  | Authorization   |
|          |                                                           | Server          |       
|          | <--------------4. Access Token ------------------------   |                 |
|          |                                                           +-----------------+
|          |
|          |                                                           +-----------------+
|          | ---------------5. Access Token ------------------------>  |                 |
|          |                                                           | Resource Server |
|          | <--------------6. Protected Resource ------------------   |                 |
+----------+                                                           +-----------------+
```
  1. 用户打开客户端以后，客户端要求用户给予授权。
  2. 用户同意给予客户端授权。
  3. 客户端使用上一步获取的授权， 向认证服务器申请令牌。
  4. 认证服务器对客户端进行认证后， 确认无误， 同意发放令牌。
  5. 客户端使用令牌，向资源服务器申请获取资源。
  6. 资源服务器确认令牌无误， 同意向客户端开放资源。

  上面六个步骤中， 不难看出， 第二步是关键，即用户怎样才能给客户端授权。 有了这个授权以后， 客户端就可以获得令牌， 进而凭令牌获取资源。
  
客户端授权模式
-----------------
  客户端必须得到用户对授权(authorization grant), 才能获得令牌(access token). OAuth 2.0定义了四种授权方式。
  1. 授权码模式(authorization code)
  2. 简化模式(implicit)
  3. 密码模式(resource owner password credentials)
  4. 客户端模式(client credentials)

授权码模式
-----------
  授权码模式是功能最完整、流程最严密的授权模式。 它的特点就是通过客户端的后台服务器，与服务提供商的认证服务器进行互动。
  
```
+-----------------+
| Resource Owner  |
+-----------------+
0        ^
0        |
0       (2)
0        |
+-----------------+                                                          +-------------------+
|                 | >------ 1. Client Identifier & Redirection URI ------->  |                   |
|                 |                                                          |   Authorization   |
|    User Agent   | >------ 2. User Authorization ------------------------>  |                   |
|                 |                                                          |      Server       |
|                 | <------ 3. Authorization Code ------------------------<  |                   |
+-----------------+                                                          +-------------------+
0   ^         |                                                                ^             V
0   |         |                                                                |             |
0  (1)       (3)                                                               |             |
0   |         |                                                                |             |
0   |         V                                                                |             |
+-----------------+                                                            |             |
|                 | >------ 4. Authorization Code & Redirection URI -----------+             |
|     Client      |                                                                          |
|                 | <------ 5. Access Token (Optional Refresh Token) ------------------------+
+-----------------+
```

参考链接
============
1. [OAuth 2.0](http://www.ruanyifeng.com/blog/2014/05/oauth_2_0.html)
2. [OAuth Wiki](https://zh.wikipedia.com/wiki/OAuth)
