### 第三章 内存管理

  托管语言例如PHP和非托管语言比如C的最大不和谐的区别在于内存指针的管控。
  
-------------------------

#### 内存
  在PHP中，产生一个字符串变量非常简单`<?php $str = "hello world";?>`, 并且字符串可以随意修改，赋值，移动。 另一方面，在C语言中，虽然你能使用诸如此类的`char *str = "hello world";`, 这个字符串不能修改，因为它位于程序空间。要创建一个可操作字符串，你将不得不分配一块内存以及通过诸如strdup()这样的函数拷贝这些内容。
```
{
  char *str;
  str = strdup("hello world");
  if(!str) {
    fprintf(stderr, "Unable to allocate memory!");
  }
}
```
  本章你将探索的几个原因在于，传统内存管理函数(malloc(), free(), strdup(), realloc(), calloc()等等)基本上都不能通过PHP源代码直接使用。

##### 释放malloc分配的内存
  几乎所有平台的内存管理都是基于请求内存、释放内存的处理过程。 应用程序与其上面的层进行通话(通常是操作系统)"我需要用一些字节内存来使用"。 如果还有空间可用，操作系统提供内存给程序，并标记这个内存块不再给其他应用程序使用。
  
  当应用程序使用内存操作完成，它希望将内存返还给操作系统， 以便能分配给其他有需要的应用。如果程序不归还内存，操作系统没有办法知道它不再使用那些内存， 也就无法分配给其他进程使用。 如果内存块没有释放， 拥有内存的应用又丢失那块内存的踪迹，这就出现了所谓的泄漏， 因为这块内存不能再被其他进程使用了。
  
  在典型的客户端应用程序中，较小的罕见内存泄漏有时候可以容忍，因为知道进程将不久后会停止，泄漏的内存将会隐含的返还给操作系统。 这也不是什么伟大壮举，因为操作系统知道内存给了什么程序，并且当程序终止的时候，它可以确定这块内存不再会使用。
  
  对于长时间运行的守护进程来说， 包括web服务器比如Apache以及mod_php扩展来说，进程被设计成长时间运行的， 通常是无限时间。 因为操作系统不能清理使用的内存，任何程度的泄漏不管多小，时间长了都会变大，终究会耗尽系统资源。
  
  考虑下用户空间的stristr()函数；使用大小写不敏感的匹配查找一个字符串， 它实际上创建了要查找的字符串和被查找字符串的小写拷贝， 然后执行一个更加传统的大小写敏感匹配来查找相应的偏移位。 在字符串的偏移位定位到之后，然而，不再使用小写版本的查找字符串和被查找字符串。如果不释放这些拷贝， 那么每个脚本都使用一下stristr(), 随着时间推移将泄漏一些内存。最终web服务器进程将拥有所有的系统内存， 但是没有使用它们。
  
  理想的解决方式是，你会喊叫，写良好的、干净的、一致的代码， 确实这是绝对正确的。 在PHP解释器这样的环境里，然而，这仅仅是解决了一半。
  
##### 错误处理
  为了给到用户空间脚本和它依赖的扩展的活动请求提供保释的能力，需要存在一种突然从活动请求实体跳出的方式。 这种方式是在Zend引擎里处理的，在请求开始的时候设置一个保释地址， 然后在任何die()或exit()被调用或遇到任何致命错误(E_ERROR)的时候执行一个longjmp()到保释地址。
  
  虽然这种保释地址简化了程序流， 它几乎总是意味着资源清理代码(比如free())将被跳过，内存将会泄漏。考虑下面简单的引擎处理函数调用的代码版本。
```
void call_function(const char *fname, int fname_len TSRMLS_DC)
{
  zend_function *fe;
  char *lcase_fname;
  
  lcase_fname = estrndup(fname, fname_len);
  zend_str_tolower(lcase_fname, fname_len);
  
  if(zend_hash_find(EG(function_table),
    lcase_fname, fname_len + 1, (void **)&fe) == FAILURE) {
    zend_execute(fe->op_array TSRMLS_CC);
  } else {
    php_error_docref(NULL TSRMLS_CC, E_ERROR,
      "Call to undefined function: %s()", fname);
  }
  efree(lcase_fname);
}
```

===========================
#### 引用计数

=======================

#### 总结
