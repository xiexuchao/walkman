Connect模块解析
===============

Connect模块背景
--------------

  NodeJS的愿望是成为一个能构建高速、可伸缩的网络应用平台， 它本身具有基于事件、异步、非阻塞、回调等特性，正是基于这些特性， Node平台上的Web框架也具有不同于其他平台的一些特性， 其中Connect是众多Web框架中的佼佼者。
  
  Connect在官方介绍中， 它是Node的一个中间件框架。 超过18个捆绑中间件和一些精选第三方中间件。 尽管Connect可能不是性能最好的Node Web框架， 但它却几乎是最为流行的Web框架。 为何Connect能在众多框架中胜出， 其原因不外乎有如下几个:
  1. 模型简单
  2. 中间件易于组合和插拔
  3. 中间件易于定制和优化
  4. 丰富的中间件

  Connect自身非常简单， 其作用是基于Web服务器做中间件管理。 至于如何处理网络请求， 这些任务通过路由分派给管理的中间件们进行处理。 它的处理模型仅仅只是一个中间队列， 进行流式处理而已， 流式处理可能性能不是最优， 但是却是最易于被理解和接受。 基于中间件可以自由组合和插拔的情况， 优化它十分容易。
  
  Connect模块目前在NPM仓库的MDO(被依赖最多的模块)排行第八位。 但这并没有真实反映出它的价值， 因为排行第五位的express框架实际上是依赖connect创建而成的。 
  
中间件
------

  让我们回顾下node最简单的web服务器是如何编写的:
```
var http = require('http');
http.createServer(function(req, res) {
  res.writeHead(200, {'Content-Type': 'text/plain'});
  res.end('Hello World\n');
}).listen(1337, '127.0.0.1');
```

  我们从最朴素的Web服务器处理流程开始， 可以看到HTTP模块基于事件处理网络访问无外乎两个主要因素， 请求和响应。 同理的是Connect中间件也是扮演这样一个角色， 处理请求， 然后响应客户端或是让下一个中间件继续处理。 如下是一个中间件最朴素的原型:
```
function(req, res, next) {
  // 中间件
}
```

  在中间件的上下文中， 有着三个变量， 分别代表请求对象、响应对象、下一个中间件。 如果当前中间件调用了res.end()结束了响应， 执行下一个中间件就显得没有必要。
  
流式处理
----------
  为了演示中间件的流式处理，我们可以看看中间件的使用形式:
```
  var app = connect();
  // Middleware
  app.use(connect.staticCache());
  app.use(connect.static(__dirname + '/public'));
  app.use(connect.cookieParser());
  app.use(connect.session());
  app.use(connect.query());
  app.use(connect.bodyParser());
  app.use(connect.csrf());
  app.use(function(req, res, next){
    // 中间件
  });
  app.listen(3001);
```

  Connect提供use方法用于注册中间件到一个connect对象队列中， 我们称该队列叫做中间件队列。
  
```
+-------------------------------------+
|  +------------+                     |
|  |  Request   |                     |
|  +------------+      +-----------+  |
|                      |  next     |  |         中间件
|  +------------+      +-----+-----+  |
|  |  Response  |            |        |
|  +------------+            |        |
+----------------------------+--------+
1                            |
1                            |
1                            |
+----------------------------V--------+
|  +------------+                     |
|  |  Request   |                     |
|  +------------+      +-----------+  |
|                      |  next     |  |          中间件
|  +------------+      +-----+-----+  |
|  |  Response  |            |        |
|  +------------+            |        |
+----------------------------+--------+
1                            |
1                            |
1                            |
+----------------------------V--------+
|  +------------+                     |
|  |  Request   |                     |
|  +------------+      .............  |
|                      .  next     .  |          中间件
|  +------------+      .............  |
|  |  Response  |                     |
|  +------------+                     |
+-------------------------------------+
```

  Connect的部分核心代码如下， 它通过use方法来维护一个中间件队列。 然后在请求来临的时候，依次调用队列中的中间件， 直到某个中间件不在调用下一个中间件为止。
```
app.stack = [];
app.use = function(route, fn) {
  // ...
  
  // add the middleware
  debug('use %s %s', route || '/', fn.name || 'anonymous');
  
  this.stack.push({ route: toute, handle: fn });
  
  return this;
};
```
  值得注意的是， 必须要有一个中间调用res.end()方法来告知客户端请求已被处理完成， 否则客户端将一直处于等待状态。
  
  流式处理也是Node中用于流程控制的经典模式， Connect模块是典型的应用了它。 流式处理的好处在于，每一个中间层的指责都是单一的， 开发者通过这个模式可以将复杂的业务逻辑进行分解。
  
路由
------
  从前面我们可以看到app.use()方法接受两个参数，route和fn, 即路由信息和中间件函数， 一个完整的中间件，其实包含路由信息和中间件函数。 路由信息的作用是过滤不匹配的URL. 请求在遇见路由信息不匹配时， 直接传递给下一个中间件处理。
  
  通常在调用app.use()注册中间件时， 只需要传递一个中间件函数即可。实际上这个过程中， connect会将/作为该中间件的默认路由， 它表示所有的请求都会被该中间件处理。 中间件的优势类似于java的过滤器， 能够全局性地处理一些事务， 使得业务逻辑保持简单。 任何事务都有两面性， 当你调用app.use()添加中间件的时候， 需要考虑的是中间件队列是否太长， 因为每一层中间件的调用都是会降低性能的。 为了提高性能， 在添加中间件的时候， 如非全局需求的，尽量附带上精确的路由信息。
  
  以multipart中间件为例， 它用于处理表单提交的稳健信息，相对而言较为耗费资源。 它存在潜在的问题，那就是有可能被人在客户端恶意提交稳健，造成服务器资源的浪费。 如果不采用路由信息加以限制，那么任何url都可以被攻击。
  `app.use('/upload', connect.multipart({ uploadDir: path}));`
  
  加上精确的路由信息后， 可以将问题减小。
  
MVC目录
-------
  借助Connect可以自由定制中间件的优势， 可以自行提升性能或设计出适合自己需要的项目。 connect自身提供了路由功能， 在此基础上， 可以轻松搭建MVC模式的框架， 以达到开发效率和执行效率的平衡。 以下是笔者项目中采用的目录结构， 清晰地划分目录结构可以帮助划分代码地职责， 此处仅供参考。
```
  +------ Makefile // 构建文件，通常用于启动单元测试运行等操作
  |------ app.js // 应用文件
  |------ automation     // 自动化测试目录
  |------ bin            // 存放启动应用相关脚本的目录
  |------ conf           // 配置文件目录
  |------ controllers   // 控制层目录
  |------ helpers       // 帮助类库
  |------ middlewares   // 自定义中间件目录
  |------ models        // 数据层目录
  |------ node_modules  // 第三方模块目录
  |------ package.json  // 项目包描述文件
  |------ public        // 静态文件目录
  |        |-------- images // 图片目录
  |        |-------- libs   // 第三方javascript库目录
  |        |-------- scripts // 前端javascript脚本目录
  |        |-------- styles  // 样式表目录
  |
  |------ test            // 单元测试目录
  |------ views           // 视图层目录
```


深入了解中间件
=================

  如果把http处理过程比作污水处理， 中间件就像是一层层过滤网。 每个中间件在http处理过程中通过改写request或/和response的数据、状态，实现了特定的功能。 这些功能十分广泛， 下图列出了connect所有内置中间件和部分第三方中间件。这里是完整的[中间件列表](https://github.com/senchalabs/connect/wiki).
  
  下图根据中间件在整个http处理流程中的位置，将中间件大致分为3类:
  1. Pre-Request: 通常用来改写request的原始数据
  2. Request/Response: 大部分中间件都在这里， 功能各异
  3. Post-Response: 全局异常处理，改写response数据等

```
0                                                   +----------- timeout
0                                                   |----------- limit
0                     +------------------+          |----------- vhost
0             +-------| Pre-Request      |----------+----------- query
0             |       +------------------+          |----------- Header -------- methodOverride
0             |
0             |                                                                                     |--- multipart
0             |                                     +----------- Dynamic Page ------- bodyParse ----+--- json
0             |                                     |                                               |--- urlencoded
0             |                                     |
0             |                                     |
0             |                                     |                               |------ static ----- staticCache
0             |                                     |----------- Static Page -------+------ directory
0             |                                     |                               |------ favicon
0             |                                     |
0             |                                     |
0             |                                     |                       |------- cookieParser
0             |                                     |                       |
0             |                                     |                       |
0             |                                     |                       |             |-- connect-mysql
0             |                                     |-- Static Management --+-- session --+-- connect-mangodb
0             |                                     |                       |             |-- connect-memcached
0             |                                     |                       |
+---------+   |       +------------------+          |                       +--- cookieSession
| connect |---+-------| Request/Response |----------+
+---------+   |       +------------------+          | 
1             |                                     |
1             |                                     |
1             |                                     |
1             |                                     |
1             |                                     |                   +------ csrf
1             |                                     |                   |------ basicAuth
1             |                                     +---- Security -----+------ connect-auth
1             |                                                         |------ helmet
1             |                                                         
1             |                                                         
1             |                                                         
1             |                                                         
1             |                                                         
1             |                                                         
1             |                                       +----------- errorHandler
1             |                                       |
1             |                                       |----------- compression
1             |                                       |
1             |                                       |
1             |                                       |                 
1             |                                       |----------- logger                
1             |       +------------------+            |
1             +-------| Post-Response    |------------+----------- responseTime
1                     +------------------+            |
1                                                     |
1                                                     |          
1                                                     |                       |------ connect-header
1                                                     +----------- Header ----+
1                                                                             |------ connect-server
```
