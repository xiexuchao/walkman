Connect模块解析
===============

Connect模块背景
--------------

  NodeJS的愿望是成为一个能构建高速、可伸缩的网络应用平台， 它本身具有基于事件、异步、非阻塞、回调等特性，正是基于这些特性， Node平台上的Web框架也具有不同于其他平台的一些特性， 其中Connect是众多Web框架中的佼佼者。
  
  Connect在官方介绍中， 它是Node的一个中间件框架。 超过18个捆绑中间件和一些精选第三方中间件。 尽管Connect可能不是性能最好的Node Web框架， 但它却几乎是最为流行的Web框架。 为何Connect能在众多框架中胜出， 其原因不外乎有如下几个:
  1. 模型简单
  2. 中间件易于组合和插拔
  3. 中间件易于定制和优化
  4. 丰富的中间件

  Connect自身非常简单， 其作用是基于Web服务器做中间件管理。 至于如何处理网络请求， 这些任务通过路由分派给管理的中间件们进行处理。 它的处理模型仅仅只是一个中间队列， 进行流式处理而已， 流式处理可能性能不是最优， 但是却是最易于被理解和接受。 基于中间件可以自由组合和插拔的情况， 优化它十分容易。
  
  Connect模块目前在NPM仓库的MDO(被依赖最多的模块)排行第八位。 但这并没有真实反映出它的价值， 因为排行第五位的express框架实际上是依赖connect创建而成的。 
  
中间件
------

  让我们回顾下node最简单的web服务器是如何编写的:
```
var http = require('http');
http.createServer(function(req, res) {
  res.writeHead(200, {'Content-Type': 'text/plain'});
  res.end('Hello World\n');
}).listen(1337, '127.0.0.1');
```

  我们从最朴素的Web服务器处理流程开始， 可以看到HTTP模块基于事件处理网络访问无外乎两个主要因素， 请求和响应。 同理的是Connect中间件也是扮演这样一个角色， 处理请求， 然后响应客户端或是让下一个中间件继续处理。 如下是一个中间件最朴素的原型:
```
function(req, res, next) {
  // 中间件
}
```

  在中间件的上下文中， 有着三个变量， 分别代表请求对象、响应对象、下一个中间件。 如果当前中间件调用了res.end()结束了响应， 执行下一个中间件就显得没有必要。
  
流式处理
----------
  为了演示中间件的流式处理，我们可以看看中间件的使用形式:
```
  var app = connect();
  // Middleware
  app.use(connect.staticCache());
  app.use(connect.static(__dirname + '/public'));
  app.use(connect.cookieParser());
  app.use(connect.session());
  app.use(connect.query());
  app.use(connect.bodyParser());
  app.use(connect.csrf());
  app.use(function(req, res, next){
    // 中间件
  });
  app.listen(3001);
```

  Connect提供use方法用于注册中间件到一个connect对象队列中， 我们称该队列叫做中间件队列。
  
```
+-------------------------------------+
|  +------------+                     |
|  |  Request   |                     |
|  +------------+      +-----------+  |
|                      |  next     |  |         中间件
|  +------------+      +-----+-----+  |
|  |  Response  |            |        |
|  +------------+            |        |
+----------------------------+--------+
1                            |
1                            |
1                            |
+----------------------------V--------+
|  +------------+                     |
|  |  Request   |                     |
|  +------------+      +-----------+  |
|                      |  next     |  |          中间件
|  +------------+      +-----+-----+  |
|  |  Response  |            |        |
|  +------------+            |        |
+----------------------------+--------+
1                            |
1                            |
1                            |
+----------------------------V--------+
|  +------------+                     |
|  |  Request   |                     |
|  +------------+      .............  |
|                      .  next     .  |          中间件
|  +------------+      .............  |
|  |  Response  |                     |
|  +------------+                     |
+-------------------------------------+
```
