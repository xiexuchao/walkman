# IP协议

## 4.1 IP即网际协议
  TCP/IP的心脏是互联网层。这一层主要由IP和ICMP(Internet Control Message Protocol)两个协议组成。
  
### 4.1.1 IP相当于OSI参考模型的第三层
  IP相当于OSI参考模型的第三层--网络层。
  网络层的主要作用是"实现终端节点之间的通信"。这种终端节点之间的通信也叫点对点通信(end-to-end)。
  
  从前面的章节可以知道，网络层的下一层--数据链路层主要作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使在不同的数据链路上也能实现两端节点之间的数据包传输。
  
  IP的主要作用就是在复杂的网络环境中，将数据包发送给最终的目标地址。
  
```
  主机与节点
  在互联网世界中，将那些配有IP地址的设备叫做“主机”。在互联网初期，只能连接大型的设备，因此习惯上就把配置有IP地址的设备称为主机。 而如今，互联网除了连接大型计算机，还能连接小型计算机，以及路由器，交换机什么的。
  
  准确来说，主机的定义应该是配置有ip地址，但是不进行路由控制的设备。既配置有IP又有路由控制能力的设备叫做路由器，跟主机有所区别。 而节点是主机和路由器的统称。
```

### 4.1.2 网络层与数据链路层的关系
  数据链路层提供两个设备之间的通信功能。与之相比，作为网络层的IP则负责在没有直连的两个网络之间进行通信传输。 那么为什么一定需要这样的两个层呢?它们之间的区别又是什么呢?
  
  在此，我们以旅行为例来说明这个问题。有个任想要去一个很远的地方旅行，并且计划先后乘坐飞机、火车、公交车到达目的地。为此，他决定先去旅行社购买机票和火车票。
  
  旅行社不仅为他预定好了旅途过程中苏需要的机票和火车票，甚至为他制定了一个详细行程表，详细到几点几分需要乘坐飞机或火车都一目了然。
  
  当然，机票和飞机票只有特定区间内有效，当你换乘不同公司的飞机或火车时，还需要重新购票。
  
  仔细分析以下机票和火车票，不难发现，每张票只能够在某一限定区间内移动。此处的区间内就如同通信网络上的数据链路。而这个区间内的出发地点和目的地点就如同某一个数据链路的源地址和目标地址等首部信息。 整个全程的行程表的作用就相当于网络层。
  
  如果我们只有行程表而没有车票，就无法搭乘交通工具到达目的地。反之，如果除了车票其他什么都没有，恐怕也很难达到目的地。 因为你不知道该坐什么车，也不知道该在哪里换乘。因此，只有两者兼备，既有某个区间的车票又又整个旅行的行程表，才能保证到达目的地。 与之类似， 计算机网络中也需要数据链路层和网络层这个分层才能实现像最终目标地址的通信。
  
## 4.2 IP基础知识
  IP大致分为三大作用模块，它们是IP寻址、路由(最终节点为止的转发)以及IP分包与组包。
  
### 4.2.1 IP地址属于网络层地址
  在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行表示。在第三章，我们介绍过数据链路的MAC地址。MAC地址正是用来标识同一个链路中不同计算机的一种识别码。
  
  作为网络层的IP, 也有这种地址信息。一般叫做IP地址。IP地址用于在连接到网络中的所有主机中识别出进行通信的目标地址。因此，在TCP/IP通信中所有主机或路由器必须设定自己的IP地址。
  
  不论一台主机与那些数据链路连接，其IP地址的形式都保持不变。以太网、无线局域网、PPP等，都不会改变IP地址的形式。网络层对数据链路层的某些特性进行了抽象。数据链路的类型对IP地址形式透明，这本身就是其中抽象化的一点。
  
  另外，在网桥或交换集线器等物理层或数据链路层数据包转发设备中，不需要设置IP地址。因为这些设备只负责将IP包转换为0、1比特流或对数据链路帧的数据部分进行转发，而不需要应对IP协议。
  
### 4.2.2 路由控制
  路由控制是指将分组数据发送到最终目标地址的功能。即使网络非常复杂，也可以通过路由控制器确定到达目标地址的通路。一旦这个路由控制的运行出现异常，分组数据极有可能迷失，无法到达目标地址。因此，一个数据包之所以能够成功到达最终的目标地址，全靠路由控制。
  
  发送数据至最终目标地址。
  Hop中文翻译为"跳", 它是指网络中的一个区间。IP包正是在网络中的一个跳间被转发。因此IP路由也叫做多跳路由。在每一个区间内决定着包在下一跳被转发的路径。
  
```
  一跳(Hop)的范围
  一跳指利用数据链路层以下分层的功能传输数据帧的一个区间。
  
  以太网等数据链路中使用MAC地址传输数据帧。此时的一跳是指从源MAC地址到目标MAC地址之间传输帧的区间。 也就是说它是主机或路由器网卡不经其他路由器而能直接到达相邻主机或路由器网卡之间的一个区间。在一跳的这个区间内，电缆可以通过网桥或交换集线器相连，不会通过路由器或网关相连。
```

  多跳路由是指路由器或主机在转发IP数据包时只指定下一个路由器或主机，而不是将到最终目标地址为止的所有通路全部指定出来。因为每一个区间(跳)在转发IP数据包时会分别指定下一跳的操作，直至包达到最终的目标地址。
  
  
