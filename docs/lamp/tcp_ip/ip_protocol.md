# IP协议

## 4.1 IP即网际协议
  TCP/IP的心脏是互联网层。这一层主要由IP和ICMP(Internet Control Message Protocol)两个协议组成。
  
### 4.1.1 IP相当于OSI参考模型的第三层
  IP相当于OSI参考模型的第三层--网络层。
  网络层的主要作用是"实现终端节点之间的通信"。这种终端节点之间的通信也叫点对点通信(end-to-end)。
  
  从前面的章节可以知道，网络层的下一层--数据链路层主要作用是在互连同一种数据链路的节点之间进行包传递。而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使在不同的数据链路上也能实现两端节点之间的数据包传输。
  
  IP的主要作用就是在复杂的网络环境中，将数据包发送给最终的目标地址。
  
```
  主机与节点
  在互联网世界中，将那些配有IP地址的设备叫做“主机”。在互联网初期，只能连接大型的设备，因此习惯上就把配置有IP地址的设备称为主机。 而如今，互联网除了连接大型计算机，还能连接小型计算机，以及路由器，交换机什么的。
  
  准确来说，主机的定义应该是配置有ip地址，但是不进行路由控制的设备。既配置有IP又有路由控制能力的设备叫做路由器，跟主机有所区别。 而节点是主机和路由器的统称。
```

### 4.1.2 网络层与数据链路层的关系
  数据链路层提供两个设备之间的通信功能。与之相比，作为网络层的IP则负责在没有直连的两个网络之间进行通信传输。 那么为什么一定需要这样的两个层呢?它们之间的区别又是什么呢?
  
  在此，我们以旅行为例来说明这个问题。有个任想要去一个很远的地方旅行，并且计划先后乘坐飞机、火车、公交车到达目的地。为此，他决定先去旅行社购买机票和火车票。
  
  旅行社不仅为他预定好了旅途过程中苏需要的机票和火车票，甚至为他制定了一个详细行程表，详细到几点几分需要乘坐飞机或火车都一目了然。
  
  当然，机票和飞机票只有特定区间内有效，当你换乘不同公司的飞机或火车时，还需要重新购票。
  
  仔细分析以下机票和火车票，不难发现，每张票只能够在某一限定区间内移动。此处的区间内就如同通信网络上的数据链路。而这个区间内的出发地点和目的地点就如同某一个数据链路的源地址和目标地址等首部信息。 整个全程的行程表的作用就相当于网络层。
  
  如果我们只有行程表而没有车票，就无法搭乘交通工具到达目的地。反之，如果除了车票其他什么都没有，恐怕也很难达到目的地。 因为你不知道该坐什么车，也不知道该在哪里换乘。因此，只有两者兼备，既有某个区间的车票又又整个旅行的行程表，才能保证到达目的地。 与之类似， 计算机网络中也需要数据链路层和网络层这个分层才能实现像最终目标地址的通信。
  
## 4.2 IP基础知识
  IP大致分为三大作用模块，它们是IP寻址、路由(最终节点为止的转发)以及IP分包与组包。
  
### 4.2.1 IP地址属于网络层地址
  在计算机通信中，为了识别通信对端，必须要有一个类似于地址的识别码进行表示。在第三章，我们介绍过数据链路的MAC地址。MAC地址正是用来标识同一个链路中不同计算机的一种识别码。
  
  作为网络层的IP, 也有这种地址信息。一般叫做IP地址。IP地址用于在连接到网络中的所有主机中识别出进行通信的目标地址。因此，在TCP/IP通信中所有主机或路由器必须设定自己的IP地址。
  
  不论一台主机与那些数据链路连接，其IP地址的形式都保持不变。以太网、无线局域网、PPP等，都不会改变IP地址的形式。网络层对数据链路层的某些特性进行了抽象。数据链路的类型对IP地址形式透明，这本身就是其中抽象化的一点。
  
  另外，在网桥或交换集线器等物理层或数据链路层数据包转发设备中，不需要设置IP地址。因为这些设备只负责将IP包转换为0、1比特流或对数据链路帧的数据部分进行转发，而不需要应对IP协议。
  
### 4.2.2 路由控制
  路由控制是指将分组数据发送到最终目标地址的功能。即使网络非常复杂，也可以通过路由控制器确定到达目标地址的通路。一旦这个路由控制的运行出现异常，分组数据极有可能迷失，无法到达目标地址。因此，一个数据包之所以能够成功到达最终的目标地址，全靠路由控制。
  
  发送数据至最终目标地址。
  Hop中文翻译为"跳", 它是指网络中的一个区间。IP包正是在网络中的一个跳间被转发。因此IP路由也叫做多跳路由。在每一个区间内决定着包在下一跳被转发的路径。
  
```
  一跳(Hop)的范围
  一跳指利用数据链路层以下分层的功能传输数据帧的一个区间。
  
  以太网等数据链路中使用MAC地址传输数据帧。此时的一跳是指从源MAC地址到目标MAC地址之间传输帧的区间。 也就是说它是主机或路由器网卡不经其他路由器而能直接到达相邻主机或路由器网卡之间的一个区间。在一跳的这个区间内，电缆可以通过网桥或交换集线器相连，不会通过路由器或网关相连。
```

  多跳路由是指路由器或主机在转发IP数据包时只指定下一个路由器或主机，而不是将到最终目标地址为止的所有通路全部指定出来。因为每一个区间(跳)在转发IP数据包时会分别指定下一跳的操作，直至包达到最终的目标地址。
  
  
  路由控制表
  为了将数据包发送给目标主机，所有主机都维护着一张路由控制表(Routing Table). 该表记录IP数据在下一步应该发给哪个路由器。IP包将根据这个路由表在各个数据链路上传输。
  
### 4.2.3 数据链路的抽象化
  IP是实现多个数据链路之间通信的协议。数据链路根据种类的不同个有特点。对这些不同数据链路的相异特性进行抽象化也是IP的重要作用之一。 在4.2.1我们提到，数据链路的地址可以被抽象化为IP地址。因此，对IP的上一层来说，不论底层数据链路使用的是以太网还是无线WLAN亦或是PPP,都将被一视同仁。
  
  不同数据链路有个最大的区别，就是它们各自的最大传输单位不同。就好像人们在邮寄包裹或行李时有各自的大小限制一样。
  
  MTU的值在以太网中是1500字节，在FDDI中是4352字节，而在ATM则为9180字节。IP的上一层可能会要求传送比这些MTU更多字节的数据，因此必须在线路上传送比包长还要小的MTU.
  
  为了解决这个问题，IP进行分片处理(IP Fragmentation). 顾名思义，所谓分片处理是指，将较大的IP包分成多个较小的IP包。分片的包到了对端目标地址以后会再被组合起来传输给上一层。 即从IP的上层次看，它完全可以忽略数据包再途中各个链路上的MTU,而只需要按照源地址发送的长度接收数据包。IP就是以这种方式抽象化了数据链路层，使得从上层更不容易看到底层网络构造细节。
  
  
### 4.2.4 IP是面向无连接型
  IP面向无连接。即在发包之前，不需要建立与对端目标地址之间的连接。上层如果遇到需要发送给IP的数据，该数据会立即被压缩成IP包发送出去。
  
  在面向有连接的情况下，需要实现建立连接。如果对端主机关机或不存在，也就不可能建立连接。 反之，一个没有建立连接的主机也不可能发送数据过来。
  
  而面向无连接的情况则不同。即使对端主机关机或不存在，数据包还是会被发送出去。反之，对于一台主机来说，他会何时从哪里收到数据也是不得而知的。通常应该进行网络监控，让主机只接收发给自己的数据包。若没有做好准备很有可能会错过一些该收的包。因此，在面向无连接的方式下可能会有很多冗余的通信。
  
  那么，为什么IP要采用面向无连接呢?
  
  主要有两点原因: 一是为了简化，二是为了提速。 面向连接比起面向无连接处理相对复杂。甚至管理每个连接本身就是一个相当繁琐的事情。 此外，每次通信之前都要实现建立连接， 又会降低处理速度。需要有连接时，可以委托上一层提供此项服务。因此，IP为了实现简单化与高速化采用面向无连接的方式。
  
```
  为了提高可靠性，上一层的TCP采用面向有连接型
  IP提供尽力服务(Best Effort)，意指"为了把数据包发送到最终目标地址，尽最大努力。" 
  然而，它并不做"最终收到与否的验证"。 IP数据包在途中可能会发生丢包、错位以及数据量翻倍等问题。
  如果发送端的数据未能真正发送到对端目标主机会造成严重问题。
  例如，发送一封电子邮件，如果邮件内容中很重要的一部分丢失，会让收件方无法及时获取信息。
  
  因此提高通信的可靠性很重要。TCP就提供这种功能。如果说IP只负责将数据发给目标主机，那么TCP则负责保证对端主机确实收到数据。
  
  那么，有人可能会提出疑问:为什么不然IP具有可靠传输的功能，从而把这两种协议合并到一起呢?
  这其中的缘由就在于，如果要一种协议规定所有的功能和作用， 那么该协议的具体实施和编程就会变得非常复杂，无法轻易实现。相比之下，按照网络分层，明确定义没层协议的作用和责任以后，针对没层具体的协议进行编程会更加有利于该协议的实现。
  
  网络通信中如果能进行有效分层，就可以明确TCP与IP各自协议的最终目的，也有利于后续对这些协议进行扩展和性能上的优化。分层也简化了每个协议的具体实现。互联网能够发展到今天，与网络通信的分层密不可分。
```

## 4.3 IP地址的基础知识
  在用TCP/IP通信时，用IP地址识别主机和路由器。为了保证正常通信，有必要为每个设备配置正确的IP地址。在互联网通信中，全世界都必须设定正确的IP地址。否则，根本无法实现正常的通讯。
  因此，IP地址就像是TCP/IP通信的一块基石。
  
### 4.3.1 IP地址的定义
  IP地址(IPv4)由32位正整数来表示。TCP/IP通信要求将这样的IP地址分配给每一个参与通信的主机。IP地址在计算机内部都以二进制方式被处理。 然而，由于人类社会并不习惯于采用二进制方式，需要采用一种特殊的标记方式。那就是将32位的IP地址以每8位为一组，分成4组，每组以"."隔开，再将每组数转换为十进制数。下面举例说明这一方法。
  
## 4.7 IPv4首部
  通过IP进行通信时，需要再数据的前面加入IP首部信息。IP首部中包含这用于IP协议进行发包控制时所有的必要信息。了解IP首部的结构，也就能够对IP所提供的功能有一个详细的把握。
  
![IP Header](https://github.com/walkerqiao/walkman/blob/master/images/ip_header.png)
  
### 版本(Version)
  由4位构成，表示标识IP首部的版本号。IPv4的版本号即为4，因此在这个字段上的值也是4. 
  
### 首部长度
  由4位构成，表明IP首部的大小，单位为4字节(32比特). 对于没有可选项的IP包，首部长度则设置为5. 也就是说，当没有可选项时，IP首部的长度为20字节(4*5 = 20). 如果有可选项，这里设置为6, 即24字节。
### 区分服务(TOS: Type Of Service)
  由8比特构成，用来表明服务质量。每一位的具体含义如下：
  * 0,1,2位 优先度
  * 3 最低延迟
  * 4 最大吞吐
  * 5 最大可靠性
  * 6 最小代价
  * 3~6 最大安全
  * 7 未定义

  这个值通常由应用指定。而且现在也鼓励这种结合应用的特性设定TOS的方法。然而在目前，几乎所有的网络都无视这个字段。这不仅仅是因为在符合质量要求的情况下按其要求发送本身的功能实现起来十分困难，还因为若不符合质量要求就可能会产生不公平的现象。因此实现TOS控制变得极其复杂。这也导致TOS整个互联网几乎就没有被投入使用。不过已有人提出将TOS字段本身再划分未DSCP和ECN两个字段的建议。
```
  0 1 2 3 4 5 6 7
+------------+---+
| DSCP段     |ECN|
+------------+---+
```
  DSCP差分服务代码点是TOS的一部分。现在统称为DiffServ, 用来进行质量控制。
  如果3～5位的值为0，0～2为则被称作类别选择代码点。这样就可以像TOS的优先度那样提供8中类型的质量控制级别。 对于每一种级别所采取的措施则由提供DiffServ的运营管理者制定。为了与TOS保持一致，值越大优先度越高。如果第5位为1，标识实验或本地使用的意思。
  
  ECN显式拥塞通告， 用来报告网络拥堵情况，由两个比特构成。
  
